{% extends "base.html" %}

{% block title %}Dashboard - Smart Farming Assistant{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
{% endblock %}

{% block content %}
<div class="dashboard-layout">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <span class="logo-icon">ğŸŒ¾</span>
                <span class="logo-text">Farming Assistant</span>
            </div>
            <p class="subtitle">Smart Agriculture Platform</p>
        </div>
        
        <div class="welcome-section">
            <p class="welcome-label">Welcome back,</p>
            <h3 class="welcome-name">{{ user_name }}! ğŸ‘‹</h3>
        </div>
        
        <nav class="sidebar-nav">
            <a href="{{ url_for('dashboard.dashboard') }}" class="nav-item active">
                <span class="nav-icon">ğŸ“Š</span>
                <span class="nav-text">Dashboard</span>
            </a>
            <a href="{{ url_for('crop.crop_suggestion') }}" class="nav-item">
                <span class="nav-icon">ğŸŒ±</span>
                <span class="nav-text">Crop Suggestion</span>
            </a>
            <a href="{{ url_for('fertilizer.fertilizer_recommend') }}" class="nav-item">
                <span class="nav-icon">ğŸ§ª</span>
                <span class="nav-text">Fertilizer Advice</span>
            </a>
            <a href="{{ url_for('disease.disease_detection') }}" class="nav-item">
                <span class="nav-icon">ğŸ¦ </span>
                <span class="nav-text">Disease Detection</span>
            </a>
        </nav>
    </div>

    <!-- Green Header Section -->
    <div class="dashboard-header">        
        <div class="header-content">
            <div class="header-left">
                <h1>Dashboard</h1>
                <p>Monitor your farm's performance and get insights</p>
            </div>
            <div class="header-right">
                <button class="action-btn govt-btn">ğŸ›ï¸ Govt Schemes</button>
                <button class="action-btn tools-btn">ğŸ”§ Tools</button>
                <span class="header-date">ğŸ“… {{ current_date }}</span>
                <button class="logout-button" onclick="window.location.href='{{ url_for('auth.logout') }}'">Logout</button>
                <button class="profile-button" onclick="openProfileModal()">ğŸ‘¤ Profile</button>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="main-content">
        <!-- Content Panel -->
        <div class="content-panel">
            <!-- Greeting Card -->
            <div class="greeting-card">
                <div class="greeting-left">
                    <h2>Good Morning, {{ user_name }}! ğŸ‘‹</h2>
                    <p>Your farm is looking great today. Here's what's happening.</p>
                </div>
                <div class="weather-info">
                    <div class="weather-icon">â˜€ï¸</div>
                    <div class="weather-details">
                        <span class="temperature">28Â°C</span>
                        <span class="condition">Sunny</span>
                    </div>
                </div>
            </div>

            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon chart">ğŸ“Š</div>
                    <div class="stat-info">
                        <h3>{{ stats.total_recommendations }}</h3>
                        <p>Total Recommendations</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon plant">ğŸŒ±</div>
                    <div class="stat-info">
                        <h3>{{ stats.crops_suggested }}</h3>
                        <p>Crops Monitoring</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon disease">ğŸ¦ </div>
                    <div class="stat-info">
                        <h3>{{ stats.diseases_detected }}</h3>
                        <p>Diseases Detected</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon fertilizer">ğŸ§ª</div>
                    <div class="stat-info">
                        <h3>{{ stats.fertilizers_saved }}</h3>
                        <p>Saved Fertilizers</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">ğŸŒ±</div>
                    <div class="stat-info">
                        <h3>{{ stats.active_crops }}</h3>
                        <p>Active Growing</p>
                    </div>
                </div>
            </div>

            <!-- Notifications Section -->
            {% if notifications %}
            <div class="notifications-section">
                <h3 class="section-title">ğŸ”” Active Notifications</h3>
                <div class="notifications-list">
                    {% for notification in notifications %}
                    <div class="notification-card {{ notification.priority }}">
                        <div class="notification-icon">
                            {% if notification.type == 'task' %}âš¡
                            {% elif notification.type == 'harvest' %}ğŸ¯
                            {% else %}ğŸ“¢{% endif %}
                        </div>
                        <div class="notification-content">
                            <h4>{{ notification.crop }}</h4>
                            <p>{{ notification.message }}</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Active Growing Activities -->
            {% if growing_activities %}
            <div class="progress-section">
                <h3 class="section-title">ğŸŒ± Active Growing Activities</h3>
                {% for activity in growing_activities %}
                <div class="crop-progress" id="activity-{{ activity._id }}">
                    <div class="crop-header">
                        <h4 class="crop-name">{{ activity.crop_display_name }}</h4>
                        <div class="crop-actions">
                            <span class="crop-percentage">{{ activity.current_stage }}/{{ activity.tasks|length }} tasks</span>
                            <button class="delete-btn" onclick="deleteActivity('{{ activity._id }}')">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: {{ (activity.current_stage / activity.tasks|length * 100) }}%"></div>
                    </div>
                    <p class="crop-details">Started: {{ activity.start_date }} â€¢ Harvest: {{ activity.harvest_date }}</p>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Recent Activity Section -->
            <div class="recent-activity">
                <h3 class="section-title">Recent Activity</h3>
                {% if recent_activity %}
                <ul class="activity-list">
                    {% for item in recent_activity %}
                    <li class="activity-item">
                        <span class="activity-time">{{ item.time }}</span>
                        <span class="activity-text">{{ item.text }}</span>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="no-activity">No recent activity. Your dashboard will show actions like recommendations and detections here.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Profile Modal -->
<div id="profileModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>ğŸ‘¤ User Profile</h2>
            <span class="close-modal" onclick="closeProfileModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="profile-info">
                <div class="profile-item">
                    <label>Full Name:</label>
                    <span>{{ user.name or 'Not provided' }}</span>
                </div>
                <div class="profile-item">
                    <label>Email:</label>
                    <span>{{ user.email or 'Not provided' }}</span>
                </div>
                <div class="profile-item">
                    <label>Phone:</label>
                    <span>{{ user.phone or 'Not provided' }}</span>
                </div>
                <div class="profile-item">
                    <label>State:</label>
                    <span>{{ user.state or 'Not provided' }}</span>
                </div>
                <div class="profile-item">
                    <label>District:</label>
                    <span>{{ user.district or 'Not provided' }}</span>
                </div>
                <div class="profile-item">
                    <label>Member Since:</label>
                    <span>
                        {% if user.created_at %}
                            {{ user.created_at.strftime('%B %d, %Y') }}
                        {% else %}
                            Registration date not available
                        {% endif %}
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function openProfileModal() {
    document.getElementById('profileModal').style.display = 'block';
}

function closeProfileModal() {
    document.getElementById('profileModal').style.display = 'none';
}

// Close modal when clicking outside of it
window.onclick = function(event) {
    const modal = document.getElementById('profileModal');
    if (event.target == modal) {
        modal.style.display = 'none';
    }
};

// Delete growing activity
function deleteActivity(activityId) {
    if (confirm('Are you sure you want to delete this growing activity?')) {
        fetch(`/growing/delete/${activityId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Remove the activity element with animation
                const activityElement = document.getElementById(`activity-${activityId}`);
                if (activityElement) {
                    activityElement.style.opacity = '0';
                    activityElement.style.transform = 'translateX(-20px)';
                    setTimeout(() => {
                        location.reload();
                    }, 300);
                } else {
                    location.reload();
                }
            } else {
                alert('Failed to delete activity: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Delete error:', error);
            alert('Error deleting activity. Please try again.');
        });
    }
}
</script>
{% endblock %}
